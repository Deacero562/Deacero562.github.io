<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SimpleSwap DEX</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; }
    label { display: block; margin-top: 1rem; }
    input, select { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
    button { margin-top: 1rem; padding: 0.75rem 1.5rem; }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>SimpleSwap DEX - Sepolia</h1>

  <div>
    <label>Swap Direction:
      <select id="swapDirection">
        <option value="AtoB">Token A → Token B</option>
        <option value="BtoA">Token B → Token A</option>
      </select>
    </label>

    <label>Amount In:
      <input type="number" id="amountIn" min="0" step="any" placeholder="Amount to swap or add liquidity" />
    </label>

    <label>Minimum Amount Out (only for swap):
      <input type="number" id="amountOutMin" min="0" step="any" placeholder="Minimum amount to receive (swap)" />
    </label>

    <label>Recipient address:
      <input type="text" id="recipient" placeholder="Address to receive tokens" />
    </label>

    <button id="connectBtn">Connect Wallet</button>
    <button id="approveBtn" disabled>Approve Tokens</button>
    <button id="addLiquidityBtn" disabled>Add Liquidity</button>
    <button id="swapBtn" disabled>Swap Tokens</button>

    <div id="status"></div>
  </div>

  <script>
    const SIMPLE_SWAP_ADDRESS = "0x344Ec156133A57169CB50D8F2A67F9E9023698Fc";
    const TOKEN_A_ADDRESS = "0xa37D029DE7c770ef8DE20fB1225167f84ae9DeC8";
    const TOKEN_B_ADDRESS = "0x788839617211f1056Ef48C3B425A102E804A5A36";

    const erc20Abi = [
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) external view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint256)"
    ];

    const simpleSwapAbi = [
      "function addLiquidity(address tokenA, address tokenB, uint256 amountADesired, uint256 amountBDesired, uint256 amountAMin, uint256 amountBMin, address to, uint256 deadline) external returns (uint256, uint256, uint256)",
      "function swapExactTokensForTokens(uint256 amountIn, uint256 amountOutMin, address[] calldata path, address to, uint256 deadline) external returns (uint256[] memory amounts)"
    ];

    let provider, signer;
    let simpleSwapContract, tokenAContract, tokenBContract;

    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask is required!");
        return;
      }
      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();

        simpleSwapContract = new ethers.Contract(SIMPLE_SWAP_ADDRESS, simpleSwapAbi, signer);
        tokenAContract = new ethers.Contract(TOKEN_A_ADDRESS, erc20Abi, signer);
        tokenBContract = new ethers.Contract(TOKEN_B_ADDRESS, erc20Abi, signer);

        document.getElementById("status").innerText = "Wallet connected!";
        document.getElementById("approveBtn").disabled = false;
        document.getElementById("addLiquidityBtn").disabled = false;
        document.getElementById("swapBtn").disabled = false;
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Failed to connect wallet.";
      }
    }

    async function approveTokens() {
      try {
        const amountInInput = document.getElementById("amountIn").value;
        if (!amountInInput) {
          alert("Please enter amount to approve.");
          return;
        }
        const amount = ethers.utils.parseUnits(amountInInput, 18);

        const address = await signer.getAddress();

        document.getElementById("status").innerText = "Approving Token A...";
        let tx = await tokenAContract.approve(SIMPLE_SWAP_ADDRESS, amount);
        await tx.wait();

        document.getElementById("status").innerText = "Approving Token B...";
        tx = await tokenBContract.approve(SIMPLE_SWAP_ADDRESS, amount);
        await tx.wait();

        document.getElementById("status").innerText = "Tokens approved!";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Approval failed: " + (error.data?.message || error.message);
      }
    }

    async function addLiquidity() {
      try {
        const amountInInput = document.getElementById("amountIn").value;
        const recipient = document.getElementById("recipient").value;
        if (!amountInInput || !recipient) {
          alert("Please fill amount and recipient.");
          return;
        }
        const amountDesired = ethers.utils.parseUnits(amountInInput, 18);

        const deadline = Math.floor(Date.now() / 1000) + 300; // 5 minutes from now

        document.getElementById("status").innerText = "Adding liquidity...";

        const tx = await simpleSwapContract.addLiquidity(
          TOKEN_A_ADDRESS,
          TOKEN_B_ADDRESS,
          amountDesired,
          amountDesired,
          amountDesired.mul(99).div(100), // amountAMin = 99% of amountDesired
          amountDesired.mul(99).div(100), // amountBMin = 99% of amountDesired
          recipient,
          deadline
        );
        await tx.wait();

        document.getElementById("status").innerText = "Liquidity added successfully!";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Add liquidity failed: " + (error.data?.message || error.message);
      }
    }

    async function swapTokens() {
      try {
        const amountInInput = document.getElementById("amountIn").value;
        const amountOutMinInput = document.getElementById("amountOutMin").value;
        const recipient = document.getElementById("recipient").value;
        const direction = document.getElementById("swapDirection").value;

        if (!amountInInput || !amountOutMinInput || !recipient) {
          alert("Please fill all fields.");
          return;
        }

        const amountIn = ethers.utils.parseUnits(amountInInput, 18);
        const amountOutMin = ethers.utils.parseUnits(amountOutMinInput, 18);
        const deadline = Math.floor(Date.now() / 1000) + 300; // +5 min

        const path = direction === "AtoB"
          ? [TOKEN_A_ADDRESS, TOKEN_B_ADDRESS]
          : [TOKEN_B_ADDRESS, TOKEN_A_ADDRESS];

        const inputToken = direction === "AtoB" ? tokenAContract : tokenBContract;

        const allowance = await inputToken.allowance(await signer.getAddress(), SIMPLE_SWAP_ADDRESS);
        if (allowance.lt(amountIn)) {
          document.getElementById("status").innerText = "Approving token...";
          const approveTx = await inputToken.approve(SIMPLE_SWAP_ADDRESS, amountIn);
          await approveTx.wait();
        }

        document.getElementById("status").innerText = "Swapping tokens...";
        const tx = await simpleSwapContract.swapExactTokensForTokens(
          amountIn,
          amountOutMin,
          path,
          recipient,
          deadline
        );
        await tx.wait();
        document.getElementById("status").innerText = "Swap completed successfully!";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Swap failed: " + (error.data?.message || error.message);
      }
    }

    document.getElementById("connectBtn").addEventListener("click", connectWallet);
    document.getElementById("approveBtn").addEventListener("click", approveTokens);
    document.getElementById("addLiquidityBtn").addEventListener("click", addLiquidity);
    document.getElementById("swapBtn").addEventListener("click", swapTokens);
  </script>
</body>
</html>
