<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SimpleSwap DEX - Sepolia</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; }
    label { display: block; margin-top: 1rem; }
    input, select { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
    button { margin-top: 1rem; padding: 0.75rem 1.5rem; }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>SimpleSwap DEX - Sepolia</h1>

  <div>
    <label>Swap Direction:
      <select id="swapDirection">
        <option value="AtoB">Token A → Token B</option>
        <option value="BtoA">Token B → Token A</option>
      </select>
    </label>

    <label>Amount In:
      <input type="number" id="amountIn" min="0" step="any" placeholder="Amount to swap or add liquidity" />
    </label>

    <label>Minimum Amount Out (only for swap):
      <input type="number" id="amountOutMin" min="0" step="any" placeholder="Minimum amount to receive (swap)" />
    </label>

    <label>Liquidity Amount to Remove:
      <input type="number" id="liquidityAmount" min="0" step="any" placeholder="LP tokens to burn" />
    </label>

    <label>Recipient address:
      <input type="text" id="recipient" placeholder="Address to receive tokens" />
    </label>

    <button id="connectBtn">Connect Wallet</button>
    <button id="faucetBtn" disabled>Get Test Tokens (Faucet)</button>    
    <button id="getPriceBtn" disabled>Get Price</button>
    <button id="swapBtn" disabled>Swap Tokens</button>    
    <button id="approveBtn" disabled>Approve Tokens</button>
    <button id="addLiquidityBtn" disabled>Add Liquidity</button>
    <button id="removeLiquidityBtn" disabled>Remove Liquidity</button>
    
    
    <div id="status"></div>
    <div id="priceDisplay" style="margin-top: 1rem; font-weight: bold;"></div>
  </div>

  <script>
    const { ethers } = window;

    const SIMPLE_SWAP_ADDRESS = ethers.utils.getAddress("0x344ec156133a57169cb50d8f2a67f9e9023698fc");
    const TOKEN_A_ADDRESS = ethers.utils.getAddress("0xa37d029de7c770ef8de20fb1225167f84ae9dec8");
    const TOKEN_B_ADDRESS = ethers.utils.getAddress("0x788839617211f1056ef48c3b425a102e804a5a36");

    const erc20Abi = [
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) external view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint256)",
      "function mint(address to, uint256 amount) external"
    ];

    const simpleSwapAbi = [
      "function addLiquidity(address tokenA, address tokenB, uint256 amountADesired, uint256 amountBDesired, uint256 amountAMin, uint256 amountBMin, address to, uint256 deadline) external returns (uint256, uint256, uint256)",
      "function removeLiquidity(address tokenA, address tokenB, uint256 liquidity, uint256 amountAMin, uint256 amountBMin, address to, uint256 deadline) external returns (uint256, uint256)",
      "function swapExactTokensForTokens(uint256 amountIn, uint256 amountOutMin, address[] calldata path, address to, uint256 deadline) external returns (uint256[] memory amounts)",
      "function getPrice(address tokenA, address tokenB) external view returns (uint256)"
    ];

    let provider, signer;
    let simpleSwapContract, tokenAContract, tokenBContract;

    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask is required!");
        return;
      }
      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();

        simpleSwapContract = new ethers.Contract(SIMPLE_SWAP_ADDRESS, simpleSwapAbi, signer);
        tokenAContract = new ethers.Contract(TOKEN_A_ADDRESS, erc20Abi, signer);
        tokenBContract = new ethers.Contract(TOKEN_B_ADDRESS, erc20Abi, signer);

        document.getElementById("status").innerText = "Wallet connected!";
        document.getElementById("approveBtn").disabled = false;
        document.getElementById("addLiquidityBtn").disabled = false;
        document.getElementById("swapBtn").disabled = false;
        document.getElementById("removeLiquidityBtn").disabled = false;
        document.getElementById("getPriceBtn").disabled = false;
        document.getElementById("faucetBtn").disabled = false;
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Failed to connect wallet.";
      }
    }

    async function approveTokens() {
      try {
        const amountInInput = document.getElementById("amountIn").value;
        if (!amountInInput) {
          alert("Please enter amount to approve.");
          return;
        }
        const amount = ethers.utils.parseUnits(amountInInput, 18);

        document.getElementById("status").innerText = "Approving Token A...";
        let tx = await tokenAContract.approve(SIMPLE_SWAP_ADDRESS, amount);
        await tx.wait();

        document.getElementById("status").innerText = "Approving Token B...";
        tx = await tokenBContract.approve(SIMPLE_SWAP_ADDRESS, amount);
        await tx.wait();

        document.getElementById("status").innerText = "Tokens approved!";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Approval failed: " + (error.data?.message || error.message);
      }
    }

    async function addLiquidity() {
      try {
        const amountInInput = document.getElementById("amountIn").value;
        const recipient = document.getElementById("recipient").value;
        if (!amountInInput || !recipient) {
          alert("Please fill amount and recipient.");
          return;
        }
        const amountDesired = ethers.utils.parseUnits(amountInInput, 18);
        const deadline = Math.floor(Date.now() / 1000) + 300;

        document.getElementById("status").innerText = "Adding liquidity...";

        const tx = await simpleSwapContract.addLiquidity(
          TOKEN_A_ADDRESS,
          TOKEN_B_ADDRESS,
          amountDesired,
          amountDesired,
          amountDesired.mul(99).div(100),
          amountDesired.mul(99).div(100),
          recipient,
          deadline
        );
        await tx.wait();

        document.getElementById("status").innerText = "Liquidity added successfully!";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Add liquidity failed: " + (error.data?.message || error.message);
      }
    }

    async function removeLiquidity() {
      try {
        const liquidityInput = document.getElementById("liquidityAmount").value;
        const recipient = document.getElementById("recipient").value;
        if (!liquidityInput || !recipient) {
          alert("Please enter liquidity amount and recipient.");
          return;
        }

        const liquidity = ethers.utils.parseUnits(liquidityInput, 18);
        const amountAMin = 0;
        const amountBMin = 0;
        const deadline = Math.floor(Date.now() / 1000) + 300;

        document.getElementById("status").innerText = "Removing liquidity...";
        const tx = await simpleSwapContract.removeLiquidity(
          TOKEN_A_ADDRESS,
          TOKEN_B_ADDRESS,
          liquidity,
          amountAMin,
          amountBMin,
          recipient,
          deadline
        );
        await tx.wait();

        document.getElementById("status").innerText = "Liquidity removed successfully!";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Remove failed: " + (error.data?.message || error.message);
      }
    }

    async function swapTokens() {
      try {
        const amountInInput = document.getElementById("amountIn").value;
        const amountOutMinInput = document.getElementById("amountOutMin").value;
        const recipient = document.getElementById("recipient").value;
        const direction = document.getElementById("swapDirection").value;

        if (!amountInInput || !amountOutMinInput || !recipient) {
          alert("Please fill all fields.");
          return;
        }

        const amountIn = ethers.utils.parseUnits(amountInInput, 18);
        const amountOutMin = ethers.utils.parseUnits(amountOutMinInput, 18);
        const deadline = Math.floor(Date.now() / 1000) + 300;

        const path = direction === "AtoB"
          ? [TOKEN_A_ADDRESS, TOKEN_B_ADDRESS]
          : [TOKEN_B_ADDRESS, TOKEN_A_ADDRESS];

        const inputToken = direction === "AtoB" ? tokenAContract : tokenBContract;

        const allowance = await inputToken.allowance(await signer.getAddress(), SIMPLE_SWAP_ADDRESS);
        if (allowance.lt(amountIn)) {
          document.getElementById("status").innerText = "Approving token...";
          const approveTx = await inputToken.approve(SIMPLE_SWAP_ADDRESS, amountIn);
          await approveTx.wait();
        }

        document.getElementById("status").innerText = "Swapping tokens...";
        const tx = await simpleSwapContract.swapExactTokensForTokens(
          amountIn,
          amountOutMin,
          path,
          recipient,
          deadline
        );
        await tx.wait();

        document.getElementById("status").innerText = "Swap completed successfully!";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Swap failed: " + (error.data?.message || error.message);
      }
    }

    async function getPrice() {
      try {
        const direction = document.getElementById("swapDirection").value;
        const tokenIn = direction === "AtoB" ? TOKEN_A_ADDRESS : TOKEN_B_ADDRESS;
        const tokenOut = direction === "AtoB" ? TOKEN_B_ADDRESS : TOKEN_A_ADDRESS;

        document.getElementById("status").innerText = "Fetching price...";
        const priceRaw = await simpleSwapContract.getPrice(tokenIn, tokenOut);
        const priceFormatted = ethers.utils.formatUnits(priceRaw, 18);

        document.getElementById("priceDisplay").innerText = `Price: 1 ${direction === "AtoB" ? "Token A" : "Token B"} = ${priceFormatted} ${direction === "AtoB" ? "Token B" : "Token A"}`;
        document.getElementById("status").innerText = "";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Get price failed: " + (error.data?.message || error.message);
      }
    }

    async function mintTokens() {
      try {
        const userAddress = await signer.getAddress();
        const amount = ethers.utils.parseUnits("1000", 18);

        document.getElementById("status").innerText = "Minting Token A...";
        let tx = await tokenAContract.mint(userAddress, amount);
        await tx.wait();

        document.getElementById("status").innerText = "Minting Token B...";
        tx = await tokenBContract.mint(userAddress, amount);
        await tx.wait();

        document.getElementById("status").innerText = "Test tokens received!";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Faucet failed: " + (error.data?.message || error.message);
      }
    }

    document.getElementById("connectBtn").addEventListener("click", connectWallet);
    document.getElementById("approveBtn").addEventListener("click", approveTokens);
    document.getElementById("addLiquidityBtn").addEventListener("click", addLiquidity);
    document.getElementById("removeLiquidityBtn").addEventListener("click", removeLiquidity);
    document.getElementById("swapBtn").addEventListener("click", swapTokens);
    document.getElementById("getPriceBtn").addEventListener("click", getPrice);
    document.getElementById("faucetBtn").addEventListener("click", mintTokens);
  </script>
</body>
</html>
