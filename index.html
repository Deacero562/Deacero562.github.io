<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SimpleSwap DEX Frontend</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js" ></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
    label { display: block; margin-top: 10px; }
    input, button { margin-top: 5px; width: 100%; padding: 8px; }
    #output { margin-top: 20px; white-space: pre-wrap; background: #f0f0f0; padding: 10px; }
  </style>
</head>
<body>

  <h1>SimpleSwap DEX</h1>

  <button id="connectButton">Connect MetaMask</button>

  <h2>Get Price</h2>
  <label>Token A address:
    <input type="text" id="tokenA" placeholder="0x..." />
  </label>
  <label>Token B address:
    <input type="text" id="tokenB" placeholder="0x..." />
  </label>
  <button id="getPriceButton">Get Price</button>
  <div id="priceResult"></div>

  <h2>Swap Tokens</h2>
  <label>Amount In (wei):
    <input type="text" id="amountIn" placeholder="1000000000000000000" />
  </label>
  <label>Amount Out Min (wei):
    <input type="text" id="amountOutMin" placeholder="0" />
  </label>
  <label>Path (comma-separated addresses):
    <input type="text" id="path" placeholder="tokenInAddress,tokenOutAddress" />
  </label>
  <label>Recipient Address:
    <input type="text" id="recipient" placeholder="0x..." />
  </label>
  <label>Deadline (unix timestamp):
    <input type="text" id="deadline" placeholder="expiration unix timestamp" />
  </label>
  <button id="swapButton">Swap Exact Tokens</button>

  <div id="output"></div>

<script>
  const CONTRACT_ADDRESS = "0x344ec156133A57169cb50d8f2A67f9e9023698fc"; 
  let provider;
  let signer;
  let contract;

  async function connect() {
    if (!window.ethereum) {
      alert("MetaMask not detected");
      return;
    }
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();

    // Cargar ABI desde archivo JSON
    const response = await fetch("SimpleSwap.abi.json");
    const abi = await response.json();

    contract = new ethers.Contract(CONTRACT_ADDRESS, abi, signer);

    document.getElementById("output").innerText = "Connected to MetaMask!";
  }

  async function getPrice() {
    const tokenA = document.getElementById("tokenA").value.trim();
    const tokenB = document.getElementById("tokenB").value.trim();
    if (!ethers.utils.isAddress(tokenA) || !ethers.utils.isAddress(tokenB)) {
      alert("Invalid token addresses");
      return;
    }
    try {
      const price = await contract.getPrice(tokenA, tokenB);
      document.getElementById("priceResult").innerText = `Price: ${price.toString()}`;
    } catch (error) {
      document.getElementById("priceResult").innerText = "Error: " + error.message;
    }
  }

  async function swapExactTokens() {
    if (!contract) {
      alert("Connect MetaMask first");
      return;
    }
    const amountIn = document.getElementById("amountIn").value.trim();
    const amountOutMin = document.getElementById("amountOutMin").value.trim();
    const pathRaw = document.getElementById("path").value.trim();
    const recipient = document.getElementById("recipient").value.trim();
    const deadline = document.getElementById("deadline").value.trim();

    if (!amountIn || !amountOutMin || !pathRaw || !recipient || !deadline) {
      alert("Complete all fields");
      return;
    }

    const path = pathRaw.split(",").map(s => s.trim());

    for (const addr of path) {
      if (!ethers.utils.isAddress(addr)) {
        alert("Invalid address in path: " + addr);
        return;
      }
    }
    if (!ethers.utils.isAddress(recipient)) {
      alert("Invalid recipient address");
      return;
    }

    try {
      // Primero hay que aprobar el token de entrada para que el contrato SimpleSwap pueda transferirlos
      // Asumimos que path[0] es el tokenIn
      const tokenInAddress = path[0];
      const tokenInContract = new ethers.Contract(tokenInAddress, [
        "function approve(address spender, uint256 amount) public returns (bool)"
      ], signer);

      const txApprove = await tokenInContract.approve(CONTRACT_ADDRESS, amountIn);
      await txApprove.wait();

      // Ejecutar swapExactTokensForTokens
      const tx = await contract.swapExactTokensForTokens(
        amountIn,
        amountOutMin,
        path,
        recipient,
        deadline
      );
      document.getElementById("output").innerText = "Swap transaction sent: " + tx.hash;
      await tx.wait();
      document.getElementById("output").innerText += "\nSwap transaction confirmed!";
    } catch (error) {
      document.getElementById("output").innerText = "Error: " + error.message;
    }
  }

  document.getElementById("connectButton").onclick = connect;
  document.getElementById("getPriceButton").onclick = getPrice;
  document.getElementById("swapButton").onclick = swapExactTokens;
</script>

</body>
</html>
