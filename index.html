<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Conectar Wallet y Agregar Liquidez</title>
<script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js" type="application/javascript"></script>
</head>
<body>

<button id="btnConnect">Conectar Wallet</button>
<p id="status">No conectado</p>

<hr />

<h3>Agregar Liquidez</h3>
<button id="btnAddLiquidity" disabled>Agregar Liquidez</button>
<p id="result"></p>

<script>
  const btnConnect = document.getElementById('btnConnect');
  const btnAddLiquidity = document.getElementById('btnAddLiquidity');
  const status = document.getElementById('status');
  const result = document.getElementById('result');

  let provider;
  let signer;
  let userAddress;

  // Dirección del contrato SimpleUniswapRouter desplegado
  const contractAddress = '0x344ec156133a57169cb50d8f2a67f9e9023698fc';

  // ABI reducido para addLiquidity (modifica si tu contrato tiene más funciones o diferente ABI)
  const contractABI = [
    "function addLiquidity(address tokenA, address tokenB, uint256 amountADesired, uint256 amountBDesired, uint256 amountAMin, uint256 amountBMin, address to, uint256 deadline) external returns (uint256,uint256,uint256)"
  ];

  // Parámetros para addLiquidity: cámbialos según tu caso
  const tokenA = '0xa37D029DE7c770ef8DE20fB1225167f84ae9DeC8';
  const tokenB = '0x788839617211f1056Ef48C3B425A102E804A5A36';

  // Ejemplo cantidades (18 decimales)
  const amountADesired = ethers.utils.parseUnits("10", 18); // 10 tokens A
  const amountBDesired = ethers.utils.parseUnits("10", 18); // 10 tokens B

  // Slippage mínimo (ejemplo 99% de la cantidad deseada)
  const amountAMin = ethers.utils.parseUnits("9.9", 18);
  const amountBMin = ethers.utils.parseUnits("9.9", 18);

  // Deadline: ahora + 20 minutos
  const deadline = Math.floor(Date.now() / 1000) + 1200;

  btnConnect.addEventListener('click', async () => {
    if (!window.ethereum) {
      alert('MetaMask no está instalado');
      return;
    }
    try {
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      status.textContent = `Wallet conectada: ${userAddress}`;
      btnConnect.disabled = true;
      btnAddLiquidity.disabled = false;
      console.log("Wallet conectada:", userAddress);
    } catch (error) {
      console.error('Error al conectar wallet:', error);
      status.textContent = 'Error al conectar wallet';
    }
  });

  btnAddLiquidity.addEventListener('click', async () => {
    if (!signer) {
      alert('Primero conecta tu wallet');
      return;
    }

    try {
      const contract = new ethers.Contract(contractAddress, contractABI, signer);

      // IMPORTANTE: Antes de llamar addLiquidity, debes asegurarte que tu wallet haya aprobado (approve) al contrato
      // para gastar los tokens tokenA y tokenB. Si no, la transacción fallará con "allowance exceeded".
      // Esa parte la debes hacer antes o añadirla aquí.

      const tx = await contract.addLiquidity(
        tokenA,
        tokenB,
        amountADesired,
        amountBDesired,
        amountAMin,
        amountBMin,
        userAddress,
        deadline
      );

      result.textContent = 'Transacción enviada, esperando confirmación...';
      console.log('Tx hash:', tx.hash);

      const receipt = await tx.wait();
      result.textContent = `Liquidez agregada! Tx hash: ${receipt.transactionHash}`;
      console.log('Tx receipt:', receipt);
    } catch (error) {
      console.error('Error al agregar liquidez:', error);
      result.textContent = 'Error al agregar liquidez: ' + (error.data?.message || error.message || error);
    }
  });
</script>

</body>
</html>
